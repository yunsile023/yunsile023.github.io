---
layout: post
title: '群晖+ZEROTIER ONE实现内网穿透moon'
subtitle: '自己折腾'
date: 2021-08-24
categories: 群晖
cover: 'http://on2171g4d.bkt.clouddn.com/jekyll-theme-h2o-postcover.jpg'
tags: 群晖
---
<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-5f5f1b21-ef14-4219-a131-48219f6596a8"></attachment><ol><li><strong>vps安装ZeroTier</strong></li></ol><ul><li>执行命令：curl -s https://install.zerotier.com/ | sudo bash</li><li><br></li><li>执行完成 ZeroTier就已经安装完成了。</li></ul><p><strong>vps加入ZeroTier局域网</strong></p><p><br></p><ul><li>执行命令：zerotier-cli join &lt;network id&gt; #（没有&lt;&gt;）</li><li><br></li><li>完成之后按ZeroTier官网允许其入网。</li></ul><p><strong>生成moon模板</strong></p><p><br></p><ul><li>执行命令：cd /var/lib/zerotier-one</li><li><br></li><li>执行命令：zerotier-idtool initmoon identity.public &gt; moon.json</li></ul><p><strong>修改moon.json</strong></p><p><br></p><ul><li>执行命令：vi moon.json</li><li><br></li><li>修改"stableEndpoints"为 vps 的公网的 IP,例如"stableEndpoints": [ "8.8.8.8/9993" ]</li></ul><pre class="ql-syntax" spellcheck="false">{
  "id": "284b515a17",
  "objtype": "world",
  "roots": [
    {
      "identity": "284b515a17:0:d0a811e14c:0:5634a0ef9680b49d7fa518b3a013ffc61315fe24c0b4750edba82ed28e7d3936634365517f1e8a94eb28eac63f8c59b4c1a8f4e908bb5f65e95e9d0793afd641",
      "stableEndpoints": [ "192.168.191.2/9993" ]
    }
  ],
  "signingKey": "b324d84cec708d1b51d5ac03e75afba501a12e2124705ec34a614bf8f9b2c800f44d9824ad3ab2e3da1ac52ecb39ac052ce3f54e58d8944b52632eb6d671d0e0",
  "signingKey_SECRET": "ffc5dd0b2baf1c9b220d1c9cb39633f9e2151cf350a6d0e67c913f8952bafaf3671d2226388e1406e7670dc645851bf7d3643da701fd4599fedb9914c3918db3",
  "updatesMustBeSignedBy": "b324d84cec708d1b51d5ac03e75afba501a12e2124705ec34a614bf8f9b2c800f44d9824ad3ab2e3da1ac52ecb39ac052ce3f54e58d8944b52632eb6d671d0e0",
  "worldType": "moon"
}
</pre><ul><li><br></li></ul><p><strong>生成签名文件</strong></p><p><br></p><ul><li>执行命令：zerotier-idtool genmoon moon.json</li><li><br></li><li>执行之后会生产一个000000xxxx.moon的文件，<span style="color: rgb(230, 0, 0);">将这个文件用Winscp等工具从vps上下载下来。</span></li></ul><p><strong>将moon节点加入网络</strong></p><p><br></p><ul><li>执行命令：mkdir moons.d</li><li><br></li><li>执行命令：mv ./*.moon ./moons.d/</li><li><br></li><li>重启 zerotier即可。</li></ul><p><span style="color: rgb(230, 0, 0);">Linux: /var/lib/zerotier-one</span></p><p><span style="background-color: rgb(247, 247, 247); color: rgb(51, 51, 51);">或&nbsp;/var/lib/zerotier-one/moons.d&nbsp;</span></p><p><br></p><pre class="ql-syntax" spellcheck="false">	zerotier-cli listpeers
</pre><p><span style="color: rgb(51, 51, 51);">重启ZeroTier后可用zerotier-cli listpeers进行检验，是否成功添加Moon节点。</span></p><p><br></p><p>1.尝试编译没有成功</p><p>2.没有用不需要——误打误撞找到了这么个<a href="https://download.zerotier.com/RELEASES/" target="_blank" style="color: rgb(81, 136, 166);">页面</a></p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b63c97ce51c46153.png_e1080-1629788091970.png">然后奇迹出现了</span></p><p>是不是很眼熟，当下的心情就是——那画面太美不敢看啊。</p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b63ca3910b5e2669.png_e1080-1629788155273.png">热泪盈眶啊</span></p><p>所有带syn字段,spk结尾的都是ZeroTier One 给群晖的安装包，有种老鼠掉进米缸的感觉了。</p><p>但是如何确定哪个版本还要费一点周折。方法一，可以在这个<a href="https://www.synology.com/en-us/knowledgebase/DSM/tutorial/General/What_kind_of_CPU_does_my_NAS_have" target="_blank" style="color: rgb(81, 136, 166);">平台支持列表</a>查询自己cpu类型，决定下载哪个版本。但在这个列表，我却找不到我笔记本i5 cpu对应的版本，所以用方法二：网上下一个putty.exe，然后ssh连到自己群晖的终端。</p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b6460b56eadc6254.png_e1080-1629788169993.png"></span></p><p><span style="color: rgb(21, 21, 21);">启动putty</span></p><p>在hostname处输入群晖的IP，点击open。弹出窗口输入群晖用户名密码</p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b646168daa586344.png_e1080-1629788189833.png">用户密码同群晖用户密码</span></p><p>登录后打命令uname -ar，就会出现cpu版本信息，大概长这样：</p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b6461f8e07073761.png_e1080-1629788204383.png">查询cpu/系统版本号</span></p><p>这就很明显了，我这个安装在笔记本上的群晖6.1.7，是64位系统，bromolow的版本，下载<a href="https://download.zerotier.com/RELEASES/1.2.8/dist/zerotier-1.2.8r0-syn-bromolow-6.1.spk" target="_blank" style="color: rgb(81, 136, 166);">zerotier-1.2.8r0-syn-bromolow-6.1.spk</a>就可以了，这回终于没有404了，美滋滋啊。</p><p><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b63b5ebc46735206.png_e1080-1629788217592.png"></p><p>再发一遍就是图中这个东西，看到了吧。</p><p>在群晖端安装就相对简单了。登录DSM，打开套件中心，选择手动安装，找到刚刚下载的spk文件，点击下一步</p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b63d1756c1a76229.png_e1080-1629788229665.png">手动安装</span></p><p>然后会出现ZeroTier One的版本信息</p><p><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b63d18889d871947.png_e1080-1629788241426.png"></p><p>因为我系统里早已安装了ZeroTier One的套件，所以这几步只是演示，可能和第一次安装界面稍有不同。安装过程大约几分钟。安装完成后可以在主菜单找到，点击运行。</p><p><span style="color: rgb(21, 21, 21);"><img src="https://raw.githubusercontent.com/yunsile023/gitnote-images/master/gitnote/2021/08/24/5b63d2dab0aa97452.png_e1080-1629788254000.png">运行后主界面</span></p><p>运行后主界面基本没有内容， 唯一的操作就是在右下角[Network ID]填入网络id号，然后点击join。</p><p>moon软件放在<span style="background-color: rgb(247, 247, 247); color: rgb(51, 51, 51);">/var/lib/zerotier-one/moons.d下，</span><em style="background-color: rgb(247, 247, 247); color: rgb(192, 192, 192);">（这个目录是拷贝之前手工建立的）</em></p><p><br></p>