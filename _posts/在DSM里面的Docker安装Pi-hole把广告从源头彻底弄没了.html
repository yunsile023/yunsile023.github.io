<attachment contenteditable="false" data-atts="%5B%5D" data-aid=".atts-13ec601a-75df-4c08-8b63-c23c34b5b103"></attachment><p>原帖地址：<a href="https://www.jkg.tw/?p=157" target="_blank" style="color: rgb(78, 161, 219);"><span>https://www.jkg.tw/?p=157</span></a></p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194036_35127-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第1张" height="533" width="999"></p><p>之前在&nbsp;<a href="https://www.ubnt.com.cn/unifi-routing/usg/" target="_blank" style="color: rgb(78, 161, 219);"><span>UniFi USG</span></a><span>&nbsp;内建的&nbsp;</span><a href="https://zh.wikipedia.org/wiki/Dnsmasq" target="_blank" style="color: rgb(78, 161, 219);"><span>dnsmasq</span></a><span>&nbsp;服务放入&nbsp;</span><a href="https://github.com/vokins/yhosts" target="_blank" style="color: rgb(78, 161, 219);"><span>yhost</span></a><span>&nbsp;挡广告的清单</span></p><p><span>把广告在 DNS 查询时就彻底按死在地上，这样做挺好的，因为局域网内所有上网的设备</span></p><p><span>不需要额外安装软件或者设定，不管是上网还是打开任何App，全部都能享受到零广告的好处</span></p><p><span>但是 USG 一直以来都两个致命毛病</span></p><p></p><ol><li>USG 更新升级时，放入的挡广告清单会被清空</li></ol><ol><li>需要另外写脚本放它自动去更新</li></ol><p>某次在 USG 升级后又被清空，不爽了所以干脆另寻他路，结果就找到一个开源的&nbsp;<a href="https://pi-hole.net/" target="_blank" style="color: rgb(78, 161, 219);"><span>Pi-hole</span></a><span>&nbsp;！</span></p><p><span>这个项目有各种好处：</span></p><p></p><ol><li>能识别阻挡全世界超过 10 万个有害或者广告的域名</li></ol><ol><li>阻挡广告的效果可以在所有设备、所有系统以及所有App内</li></ol><ol><li>增进整体网络效能（因为广告在被下载前，已经被阻挡）</li></ol><ol><li>行动设备可以用 VPN 连回家中 Pi-hole 阻挡广告节省行动网络流量</li></ol><ol><li>有个漂亮完整的 Web 管理接口</li></ol><ol><li>提供 API ，可以在你的程式中使用</li></ol><p>可以看下 Pi-hole 他们的官方介绍影片：</p><iframe class="ql-video" frameborder="0" allowfullscreen="true" src="https://blog.gxnas.com/zb_users/upload/2018/06/20180614194142_93080."></iframe><p><br></p><p>Pi-hole 开发者目前也都很活跃，想要看完整源码可以到&nbsp;<a href="https://github.com/pi-hole/pi-hole" target="_blank" style="color: rgb(78, 161, 219);">Pi-hole Github</a>&nbsp;网页去，或者只是想要获取他们的<a href="https://github.com/pi-hole/pi-hole/blob/master/adlists.default" target="_blank" style="color: rgb(78, 161, 219);">挡广告清单</a></p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194043_67405-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第2张" height="875" width="999"></p><p>他们现行采用的挡广告清单有七个，稍微看一下，各个维护都还算勤劳</p><p>而安装好 Pi-hole 以后，系统也会在午夜时间自动抓取更新，并且自动去除重复的项目，无人值守非常方便</p><p>&nbsp;</p><p>虽然这个项目是设计给&nbsp;<a href="https://zh.wikipedia.org/wiki/%E6%A0%91%E8%8E%93%E6%B4%BE" target="_blank" style="color: rgb(78, 161, 219);">Raspberry Pi</a>&nbsp;的，不过也有人移植到 Docker 上面来</p><p>今天我们要介绍的就是在 Synology DSM 的 Docker 上面安装一套 Pi-hole</p><p>&nbsp;</p><p><br></p><ul><li>在 DSM Docker 里面下载 Pi-hole 的映像档</li></ul><p>1.在 DSM 管理页面打开 Docker</p><p>2.点选“仓库服务器”</p><p>3.在搜索字段里面输入“pi-hole”</p><p>4.点“搜寻”</p><p>5.点选“diginc/pi-hole”</p><p>6.点选“下载”</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194049_41441-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第3张" height="411" width="999"></p><p>跳出“选择标签”时，默认“latest”就可以了</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194053_28082-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第4张" height="284" width="888"></p><p>稍等片刻以后，DSM 就会下载完毕</p><p>&nbsp;</p><p><br></p><ul><li>布署 Pi-hole&nbsp;与设定 Docker 环境变量</li></ul><p>1.点选 DSM Docker 的“映像档”</p><p>2.点选刚刚下载好的映像档“diginc/pi-hole:latest”</p><p>3.点击“布署”按钮</p><p>4.点击“进阶设定”按钮</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194058_95203-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第5张" height="687" width="999"></p><p>&nbsp;</p><p>“自动重启”建议勾选，如果当机挂了或者 DSM 重新开机后，这个容器还会自动启动</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194103_81942-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第6张" height="854" width="999"></p><p>&nbsp;</p><p>为了避免以后升级 Docker 映像档后设定消失，所以我们要建立本地资料夹与容器资料夹的连结</p><p>这样容器内的设定档就会存到 DSM 本地的资料夹，这样也方便我们编辑</p><p>1.点击“储存空间”</p><p>2.点击“新增资料夹”</p><p>3.DSM 本地资料夹请随意新增两个，分别对应两个容器资料夹，设定完应该会跟下面图片一样</p><p>“/etc/pihole”这个是 pi-hole 存放设定档的地方</p><p>“/etc/dnsmasq.d”这个是 pi-hole 存放 dnsmasq 规则的地方</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194106_43427-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第7张" height="841" width="999"></p><p>&nbsp;</p><p>在“连接埠设定”页面是设定 DSM 与容器端口的映射，设定好以后我们连到 DSM IP 跟相应端口就能访问到容器</p><p>1.点选“连接埠设定”</p><p>2.pi-hole 共要设定三个端口，设定完应该如下面图片</p><p>其中因为我 DSM 已经跑一个 http 服务，所以已经占用掉 80 端口，这边我就改成 36778</p><p>53 端口是 DNS 服务器专用，如果 DSM 上面没其他 DNS Server 建议就不要修改</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194110_79533-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第8张" height="848" width="999"></p><p>&nbsp;</p><p>设定 pi-hole 环境变量，有几项比较重要需要设定</p><p>1.点击“环境设定”</p><p>2.这边列出几个比较重要的设定，完整的设定可以到 Docker 的<a href="https://hub.docker.com/r/diginc/pi-hole/" target="_blank" style="color: rgb(78, 161, 219);">网页</a>查询</p><p>“ServerIP”这边设定 DSM 的内网 IP 地址</p><p>“TZ”这边设定时区“Taipei”，有设定时区以后，Pi-hole 会在半夜时间更新广告清单</p><p>“WEBPASSWORD”这个是登入 Pi-hole 网页管理页面的密码</p><p>“DNS1”、“DNS2”这两个可以根据你的网络设定来决定，下图是 OpenDNS 的，你也可以换成自己网络运营商的，不设定的话就 Pi-hole 就会使用 Google DNS</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194114_48654-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第9张" height="841" width="999"></p><p>&nbsp;</p><p>设定完以上内容后，就全部都点“确定”或者“下一步”，最后 Pi-hole 就会正常启动了！</p><p>启动后我们就可以透过刚刚设定的 ServerIP 来登入 Pi-hole 管理页面</p><p>http://<span style="color: rgb(255, 0, 0);">[ServerIP]:[Port]</span>/admin ，修改掉红色部分，根据以上文章设定为例那就是： http://192.168.2.200:36778/admin</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194119_36761-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第10张" height="406" width="999"></p><p>浏览器输入以上网址，然后输入刚刚设定的WEBPASSWORD，就能登入管理页面囉～</p><p>登入后就能看到更多资讯，有客户端的请求纪录、添加白名单与黑名单。。等等，还有 Pi-hole 的设定选项～</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194124_95948-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第11张" height="612" width="999"></p><p>&nbsp;</p><p>以下列几个 Pi-hole 比较重要的选项</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194130_81121-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第12张" height="508" width="999"></p><p>“Pi-hole DHCP Server”如果你局域网内有其他 DHCP Server 这里就不要打开，否则会打架</p><p>“Pi-hole Block Lists”这里可以让你添加或删除广告清单，系统会在每周日凌晨 01:59 自动更新</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194134_96547-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第13张" height="1264" width="922"></p><p>另外他还支援&nbsp;<a href="https://zh.wikipedia.org/wiki/%E5%9F%9F%E5%90%8D%E7%B3%BB%E7%BB%9F%E5%AE%89%E5%85%A8%E6%89%A9%E5%B1%95" target="_blank" style="color: rgb(78, 161, 219);">DNSSEC</a>&nbsp;功能，如果你使用 Google DNS 或者其他支援 DNSSEC 的话，这里可以打开支援</p><p>Google DNS 在 2013 年的时候就已经<a href="https://security.googleblog.com/2013/03/google-public-dns-now-supports-dnssec.html" target="_blank" style="color: rgb(78, 161, 219);">支援</a>这项服务，打开后也可以到这个<a href="http://dnssec.vs.uni-due.de/" target="_blank" style="color: rgb(78, 161, 219);">网页</a>看看有没有生效？</p><p>&nbsp;</p><p>设定选项逛一圈以后，我们还需要到你路由器里面修改一下 DNS Server 指向 Pi-hole IP</p><p>每种路由器的设定方法不同，以下是以 UniFi USG 为例</p><p><img src="https://wp.gxnas.com/wp-content/uploads/2018/07/20180614194140_73896-1.png" alt="在DSM里面的Docker安装Pi-hole把广告从源头彻底弄没了 NAS 第14张" height="166" width="999"></p><p>通常路由器里面 DNS Server 应该都能设定两个，你也可以只设定一组到 Pi-hole</p><p>但是这样如果 Pi-hole 当机或者还没有启动的时候，你局域网内的设备会上不了网络</p><p>所以保险一点做法是再写一个 DNS Server 当备援</p><p>&nbsp;</p><p>设定完路由器以后，你可以把你的 iPhone 或者电脑重新连线，不知道怎么做就关闭 WiFi 再打开或者关机再开机</p><p>然后请随意开几个网站，或者打开Facebook App之类的看看，广告是不是变少许多呢。。。</p><p>汉化文件：<a href="https://wp.gxnas.com/wp-content/uploads/2018/07/201806191529403039365710.rar" target="_blank" style="color: rgb(78, 161, 219);">Pi-hole汉化.rar</a></p><p>汉化文件使用方法：</p><p>1、解压文件出来</p><p>2、打开WinSCP</p><p>3、用root登录</p><p>4、进入/var/www/html/admin</p><p>5、把解压的文件上传覆盖</p><p>&nbsp;</p><p><strong style="color: rgb(230, 0, 0);">如果用docker安装的，最好用root登录SSH，然后查找文件：find / | grep favicon.png，可能是以下路径（选中标蓝色的那行，长串数字每台机可能会有不同）。</strong></p><p><strong style="color: rgb(230, 0, 0);"><img src="https://wp.gxnas.com/wp-content/uploads/2018/06/docker%E9%87%8C%E9%9D%A2Pi-hole%E7%9A%84%E6%B1%89%E5%8C%96%E5%9C%B0%E5%9D%80-400x266.jpg" height="266" width="400"></strong></p><p><strong style="color: rgb(230, 0, 0);">&nbsp;</strong></p><p><strong style="color: rgb(230, 0, 0);">&nbsp;以上是那个博客的方法，我这边favicon.png文件没找到，查找groups-domains.php（可以搜汉化包里的文件文件名），可能找到好几条，前面目录是/var/www/html/admin/，然后我重新新建了一个cn文件夹，如/var/www/html/cn/，复制进去最新版的5.0汉化包</strong><a href="https://github.com/liyachvn/pi-hole-chinese" target="_blank" style="color: rgb(230, 0, 0);"><strong>https://github.com/liyachvn/pi-hole-chinese</strong></a><strong style="color: rgb(230, 0, 0);">，这样就</strong><a href="http://192.168.1.3/cn/index.php" target="_blank" style="color: rgb(230, 0, 0);"><strong>http://192.168.1.3/cn/index.php</strong></a><strong style="color: rgb(230, 0, 0);">(输自己ip),这样就汉英双语了。当然也可以直接覆盖admin</strong></p><p><br></p><p><span class="ql-cursor">﻿</span>/volume3/@docker/aufs/diff/85e83d86e6e0c9497920b19c2ea1ce09eb4b593caaf34b79b3f8702e0c5d4ff3/var/www/html/admin/groups-domains.php</p><p><br></p><h2>Pi-hole规则:</h2><p>http://someonewhocares.org/hosts/hosts</p><p>https://raw.githubusercontent.com/StevenBlack/hosts/master/data/StevenBlack/hosts</p><p>https://raw.githubusercontent.com/StevenBlack/hosts/master/hosts</p><p>http://sysctl.org/cameleon/hosts</p><p>http://www.montanamenagerie.org/hostsfile/hosts.txt</p><p>http://www.malwaredomainlist.com/hostslist/hosts.txt</p><p>http://adaway.org/hosts.txthttp://winhelp2002.mvps.org/hosts.txt</p><p><br></p>